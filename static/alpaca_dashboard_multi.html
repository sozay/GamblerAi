<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamblerAI Multi-Instance Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #2d3b52;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --instance-1: #3b82f6;
            --instance-2: #10b981;
            --instance-3: #f59e0b;
            --instance-4: #8b5cf6;
            --instance-5: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        select {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover {
            border-color: var(--info);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .card:hover {
            background-color: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--bg-dark);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        th:hover {
            color: var(--text-primary);
        }

        td {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: var(--bg-card-hover);
        }

        .instance-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .instance-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .instance-1 { background-color: rgba(59, 130, 246, 0.2); color: var(--instance-1); }
        .instance-2 { background-color: rgba(16, 185, 129, 0.2); color: var(--instance-2); }
        .instance-3 { background-color: rgba(245, 158, 11, 0.2); color: var(--instance-3); }
        .instance-4 { background-color: rgba(139, 92, 246, 0.2); color: var(--instance-4); }
        .instance-5 { background-color: rgba(236, 72, 153, 0.2); color: var(--instance-5); }

        .dot-1 { background-color: var(--instance-1); }
        .dot-2 { background-color: var(--instance-2); }
        .dot-3 { background-color: var(--instance-3); }
        .dot-4 { background-color: var(--instance-4); }
        .dot-5 { background-color: var(--instance-5); }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-completed {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .status-crashed {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .chart-container {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 18px;
        }

        .error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            color: var(--danger);
            margin-bottom: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            h1 {
                font-size: 24px;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .card-value {
                font-size: 28px;
            }

            th, td {
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GamblerAI Multi-Instance Trading Dashboard</h1>
        <div class="header-controls">
            <select id="instanceSelector" onchange="onInstanceChange()">
                <option value="all">All Instances</option>
                <option value="1">Instance 1</option>
                <option value="2">Instance 2</option>
                <option value="3">Instance 3</option>
                <option value="4">Instance 4</option>
                <option value="5">Instance 5</option>
            </select>
            <div class="toggle-container">
                <span style="font-size: 14px; color: var(--text-secondary);">Auto-Refresh</span>
                <label class="toggle">
                    <input type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div id="errorContainer"></div>

    <div class="summary-cards">
        <div class="card">
            <div class="card-title">Total Portfolio Value</div>
            <div class="card-value" id="totalPortfolio">$0.00</div>
            <div class="card-subtitle">Combined value across all instances</div>
        </div>
        <div class="card">
            <div class="card-title">Total P&L</div>
            <div class="card-value" id="totalPnl">$0.00</div>
            <div class="card-subtitle" id="totalPnlPercent">0.00%</div>
        </div>
        <div class="card">
            <div class="card-title">Active Positions</div>
            <div class="card-value" id="totalPositions">0</div>
            <div class="card-subtitle">Across all instances</div>
        </div>
        <div class="card">
            <div class="card-title">Overall Win Rate</div>
            <div class="card-value" id="overallWinRate">0%</div>
            <div class="card-subtitle" id="totalTradesText">0 total trades</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Instance Comparison</div>
        <div class="table-container">
            <table id="comparisonTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('instance_id')">Instance</th>
                        <th onclick="sortTable('strategy')">Strategy</th>
                        <th onclick="sortTable('active_positions')">Active Positions</th>
                        <th onclick="sortTable('total_trades')">Total Trades</th>
                        <th onclick="sortTable('win_rate')">Win Rate</th>
                        <th onclick="sortTable('pnl')">P&L</th>
                        <th onclick="sortTable('pnl_pct')">P&L %</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Performance Comparison Chart</div>
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <div class="section" id="instanceDetailsSection">
        <div class="section-title">
            <span id="instanceDetailsTitle">Active Positions - All Instances</span>
        </div>
        <div class="table-container">
            <table id="positionsTable">
                <thead>
                    <tr>
                        <th>Instance</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Entry Price</th>
                        <th>Quantity</th>
                        <th>Entry Time</th>
                        <th>Stop Loss</th>
                        <th>Take Profit</th>
                    </tr>
                </thead>
                <tbody id="positionsTableBody">
                    <tr><td colspan="8" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <div class="section-title">
            <span id="recentTradesTitle">Recent Closed Trades</span>
        </div>
        <div class="table-container">
            <table id="tradesTable">
                <thead>
                    <tr>
                        <th>Instance</th>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>Entry Price</th>
                        <th>Exit Price</th>
                        <th>Quantity</th>
                        <th>Duration</th>
                        <th>P&L</th>
                        <th>P&L %</th>
                        <th>Exit Reason</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <tr><td colspan="10" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/alpaca';
        let autoRefreshInterval = null;
        let currentInstanceId = 'all';
        let comparisonData = [];
        let performanceChart = null;
        let sortColumn = 'instance_id';
        let sortDirection = 'asc';

        // Instance colors
        const INSTANCE_COLORS = {
            1: 'rgb(59, 130, 246)',
            2: 'rgb(16, 185, 129)',
            3: 'rgb(245, 158, 11)',
            4: 'rgb(139, 92, 246)',
            5: 'rgb(236, 72, 153)'
        };

        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                showError(`Failed to fetch data from ${endpoint}`);
                return null;
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '0.00%';
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDuration(minutes) {
            if (!minutes) return '-';
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function getInstanceBadge(instanceId) {
            return `
                <span class="instance-badge instance-${instanceId}">
                    <span class="instance-dot dot-${instanceId}"></span>
                    Instance ${instanceId}
                </span>
            `;
        }

        function getStatusBadge(status) {
            return `<span class="status-badge status-${status}">${status}</span>`;
        }

        async function loadInstanceComparison() {
            const instances = await fetchAPI('/instances');
            if (!instances) return;

            let totalPnl = 0;
            let totalPositions = 0;
            let totalTrades = 0;
            let totalWinningTrades = 0;
            let totalClosedTrades = 0;

            const tbody = document.getElementById('comparisonTableBody');

            if (instances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No instances found</td></tr>';
                return;
            }

            tbody.innerHTML = instances.map(inst => {
                totalPnl += inst.current_pnl || 0;
                totalPositions += inst.active_positions || 0;
                totalTrades += inst.total_trades || 0;

                const closedTrades = inst.total_trades - inst.active_positions;
                totalClosedTrades += closedTrades;
                totalWinningTrades += Math.round((inst.win_rate / 100) * closedTrades);

                const pnlClass = inst.current_pnl >= 0 ? 'positive' : 'negative';
                const pnlPercent = 0; // Would need initial capital to calculate

                return `
                    <tr>
                        <td>${getInstanceBadge(inst.instance_id)}</td>
                        <td>${inst.strategy || 'Unknown'}</td>
                        <td>${inst.active_positions}</td>
                        <td>${inst.total_trades}</td>
                        <td>${inst.win_rate.toFixed(2)}%</td>
                        <td class="${pnlClass}">${formatCurrency(inst.current_pnl)}</td>
                        <td class="${pnlClass}">${formatPercent(pnlPercent)}</td>
                    </tr>
                `;
            }).join('');

            // Update summary cards
            document.getElementById('totalPnl').textContent = formatCurrency(totalPnl);
            document.getElementById('totalPnl').className = `card-value ${totalPnl >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('totalPositions').textContent = totalPositions;

            const overallWinRate = totalClosedTrades > 0
                ? (totalWinningTrades / totalClosedTrades * 100).toFixed(2)
                : 0;
            document.getElementById('overallWinRate').textContent = `${overallWinRate}%`;
            document.getElementById('totalTradesText').textContent = `${totalTrades} total trades`;

            comparisonData = instances;
        }

        async function loadComparisonChart() {
            const comparison = await fetchAPI('/comparison');
            if (!comparison || comparison.length === 0) return;

            const ctx = document.getElementById('performanceChart').getContext('2d');

            // Destroy existing chart if it exists
            if (performanceChart) {
                performanceChart.destroy();
            }

            const datasets = comparison.map(inst => ({
                label: `Instance ${inst.instance_id} (${inst.strategy || 'Unknown'})`,
                data: [0, inst.total_pnl], // Simplified - would need historical data for real chart
                borderColor: INSTANCE_COLORS[inst.instance_id] || '#ffffff',
                backgroundColor: INSTANCE_COLORS[inst.instance_id] || '#ffffff',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }));

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start', 'Current'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#f1f5f9',
                                font: {
                                    size: 12
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#334155',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: {
                                color: '#334155',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        async function loadPositions() {
            const endpoint = currentInstanceId === 'all'
                ? '/positions/active'
                : `/positions/active?instance_id=${currentInstanceId}`;

            const positions = await fetchAPI(endpoint);
            if (!positions) return;

            const tbody = document.getElementById('positionsTableBody');

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No active positions</td></tr>';
                return;
            }

            tbody.innerHTML = positions.map(pos => `
                <tr>
                    <td>${getInstanceBadge(pos.instance_id)}</td>
                    <td><strong>${pos.symbol}</strong></td>
                    <td>${pos.direction}</td>
                    <td>${formatCurrency(pos.entry_price)}</td>
                    <td>${pos.qty}</td>
                    <td>${formatDateTime(pos.entry_time)}</td>
                    <td>${pos.stop_loss ? formatCurrency(pos.stop_loss) : '-'}</td>
                    <td>${pos.take_profit ? formatCurrency(pos.take_profit) : '-'}</td>
                </tr>
            `).join('');
        }

        async function loadRecentTrades() {
            const endpoint = currentInstanceId === 'all'
                ? '/positions/closed?limit=20'
                : `/positions/closed?limit=20&instance_id=${currentInstanceId}`;

            const trades = await fetchAPI(endpoint);
            if (!trades) return;

            const tbody = document.getElementById('tradesTableBody');

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No closed trades</td></tr>';
                return;
            }

            tbody.innerHTML = trades.map(trade => {
                const pnlClass = (trade.pnl || 0) >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${getInstanceBadge(trade.instance_id)}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td>${trade.direction}</td>
                        <td>${formatCurrency(trade.entry_price)}</td>
                        <td>${trade.exit_price ? formatCurrency(trade.exit_price) : '-'}</td>
                        <td>${trade.qty}</td>
                        <td>${formatDuration(trade.duration_minutes)}</td>
                        <td class="${pnlClass}">${formatCurrency(trade.pnl)}</td>
                        <td class="${pnlClass}">${formatPercent(trade.pnl_pct)}</td>
                        <td>${trade.exit_reason || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function updateDashboard() {
            await Promise.all([
                loadInstanceComparison(),
                loadComparisonChart(),
                loadPositions(),
                loadRecentTrades()
            ]);
        }

        function onInstanceChange() {
            const selector = document.getElementById('instanceSelector');
            currentInstanceId = selector.value;

            const titleSuffix = currentInstanceId === 'all'
                ? 'All Instances'
                : `Instance ${currentInstanceId}`;

            document.getElementById('instanceDetailsTitle').textContent = `Active Positions - ${titleSuffix}`;
            document.getElementById('recentTradesTitle').textContent = `Recent Closed Trades - ${titleSuffix}`;

            loadPositions();
            loadRecentTrades();
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');

            if (toggle.checked) {
                autoRefreshInterval = setInterval(updateDashboard, 10000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Sorting would be implemented here for the comparison table
            // For now, data is loaded from the API in instance_id order
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            toggleAutoRefresh(); // Start auto-refresh if toggle is checked
        });
    </script>
</body>
</html>
